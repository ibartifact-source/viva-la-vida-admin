<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§äººè£æ±º - ç©©å®šçœéŒ¢ç‰ˆ(ä¿®å¾©åŠŸèƒ½)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #000; overflow: hidden; margin: 0; touch-action: manipulation; }

        /* --- æ ¸å¿ƒé¦–é ä½ˆå±€ --- */
        #landing-page {
            position: fixed; inset: 0; z-index: 200; background: #ffffff;
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-between; padding: 6vh 0;
            transition: transform 0.8s cubic-bezier(0.87, 0, 0.13, 1);
        }
        .main-title-box { 
            background-color: #e63946; padding: 0.8rem 2rem; border: 6px solid #000; 
            box-shadow: 8px 8px 0px #000; transform: rotate(-2deg) scale(0.6); 
            opacity: 0; transition: all 0.6s 1s; 
        }
        .loaded .main-title-box { opacity: 1; transform: rotate(-2deg) scale(1); }

        .character-stage { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 100%; height: 50vh; pointer-events: none; 
        }
        .char-part { 
            position: absolute; height: 100%; background-size: cover; background-position: center; 
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1); border: 6px solid black; bottom: 0; pointer-events: auto;
            background-color: #222;
        }
        .boss-part { width: 45%; left: 27.5%; z-index: 30; clip-path: polygon(15% 0%, 85% 0%, 100% 100%, 0% 100%); transform: translateY(110%); }
        .minion-l-part { width: 40%; left: 5%; z-index: 20; clip-path: polygon(0% 0%, 100% 15%, 85% 100%, 0% 100%); transform: translateX(-120%) rotate(-10deg); }
        .minion-r-part { width: 40%; right: 5%; z-index: 20; clip-path: polygon(0% 15%, 100% 0%, 100% 100%, 15% 100%); transform: translateX(120%) rotate(10deg); }
        .loaded .char-part { transform: translate(0,0) rotate(0); }

        /* --- ä¸»ç¨‹å¼ä½ˆå±€ (ä¿®æ­£è·‘ç‰ˆé—œéµ) --- */
        #main-app { opacity: 0; visibility: hidden; transition: 0.5s; height: 100vh; display: flex; flex-direction: column; background: #050505; }
        #manga-viewport {
            position: relative; width: 95vw; max-width: 500px; height: calc(100vh - 250px);
            margin: 10px auto; background: #111; border: 3px solid #fff; z-index: 10; 
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .nav-zone { position: absolute; top: 0; height: 100%; width: 25%; z-index: 20; opacity: 0; cursor: pointer; }
        #side-drawer { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: #000; border-right: 2px solid #fff; z-index: 250; transition: 0.4s; padding: 2rem; }
        #side-drawer.open { left: 0; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 240; display: none; }
        .drawer-overlay.open { display: block; }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="main-title-box"><h1 class="text-4xl font-black italic text-white">ç§äººè£æ±º</h1></div>
        <div class="character-stage">
            <div id="part-l" class="char-part minion-l-part"></div>
            <div id="part-r" class="char-part minion-r-part"></div>
            <div id="part-m" class="char-part boss-part"></div>
        </div>
        <div class="flex flex-col gap-4 relative z-[130] opacity-0 transition-opacity duration-500 delay-[2s]" id="enter-btn-area">
            <button onclick="document.getElementById('bg-upload').click()" class="bg-blue-600 text-white font-black py-4 px-10 rounded-full border-4 border-white">ä¸Šå‚³å¿ƒé­”åº•åœ– ğŸ“¸</button>
            <button onclick="startApp()" class="bg-black text-white font-black py-4 px-10 rounded-full border-4 border-white">é€²å…¥è£æ±ºç³»çµ± âš¡</button>
        </div>
        <input type="file" id="bg-upload" accept="image/*" class="hidden">
    </div>

    <div id="main-app">
        <div id="drawer-overlay" class="drawer-overlay" onclick="toggleDrawer()"></div>
        <div id="side-drawer">
            <h2 class="text-xl font-black italic text-white mb-10 underline decoration-red-600">åº«å­˜æª”æ¡ˆåº«</h2>
            <div id="library-content" class="space-y-4"></div>
        </div>

        <header class="p-4 flex justify-between items-center border-b-4 border-white">
            <button onclick="toggleDrawer()"><i data-lucide="menu" class="text-white"></i></button>
            <div class="text-right">
                <h1 class="text-white font-black italic">PRIVATE JUDGMENT</h1>
                <div id="current-path" class="text-[9px] text-zinc-500 uppercase">SYNCING...</div>
            </div>
            <button onclick="triggerAdmin()" class="bg-white text-black px-4 py-1 text-xs font-bold">ç™¼å¸ƒ</button>
        </header>

        <main class="flex-grow flex flex-col items-center justify-center">
            <div id="manga-viewport">
                <div class="nav-zone" style="left:0" onclick="prevPage()"></div>
                <canvas id="mangaCanvas"></canvas>
                <div class="nav-zone" style="right:0" onclick="nextPage()"></div>
            </div>
            <div id="dot-nav" class="flex gap-2 mt-4"></div>
        </main>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/95 z-[300] hidden flex items-center justify-center p-8">
        <div class="w-full max-w-md space-y-6">
            <h2 class="text-white font-black text-2xl border-b-4 border-red-600 pb-2">GITHUB è³‡æºåŒæ­¥å™¨</h2>
            <input type="text" id="admin-cat" placeholder="åˆ†é¡ (å¦‚ï¼šç¬¬ä¸€ç« )" class="w-full p-3 bg-zinc-900 text-white border border-zinc-700">
            <input type="text" id="admin-title" placeholder="ç« ç¯€åç¨±" class="w-full p-3 bg-zinc-900 text-white border border-zinc-700">
            <input type="text" id="admin-url" placeholder="GitHub åœ–ç‰‡è·¯å¾‘ (çµå°¾å¸¶ /)" class="w-full p-3 bg-zinc-900 text-white border border-zinc-700 text-xs">
            <input type="number" id="admin-count" placeholder="ç¸½å¼µæ•¸" class="w-full p-3 bg-zinc-900 text-white border border-zinc-700">
            <button id="publish-btn" class="w-full bg-red-600 text-white py-4 font-black uppercase">ç¢ºèªåŒæ­¥é›²ç«¯</button>
            <button onclick="triggerAdmin()" class="w-full text-zinc-600 text-xs">å–æ¶ˆè¿”å›</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLLatutsYz2pohWjmuKECuCJdAMiQI0aM",
            authDomain: "vivalavida-8c032.firebaseapp.com",
            projectId: "vivalavida-8c032",
            databaseURL: "https://vivalavida-8c032-default-rtdb.asia-southeast1.firebasedatabase.app",
            storageBucket: "vivalavida-8c032.firebasestorage.app",
            messagingSenderId: "722769295864",
            appId: "1:722769295864:web:b3932fa042bc4710923e0d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let library = {}, mangaPages = [], currentIndex = 0;
        const parts = ['part-l', 'part-m', 'part-r'];
        const canvas = document.getElementById('mangaCanvas');
        const ctx = canvas.getContext('2d');

        document.getElementById('bg-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const r = new FileReader();
                r.onload = (ev) => {
                    parts.forEach(id => document.getElementById(id).style.backgroundImage = `url('${ev.target.result}')`);
                    localStorage.setItem('user_hero_bg', ev.target.result);
                };
                r.readAsDataURL(file);
            }
        };

        document.getElementById('publish-btn').onclick = async () => {
            const cat = document.getElementById('admin-cat').value.trim();
            const title = document.getElementById('admin-title').value.trim();
            const baseUrl = document.getElementById('admin-url').value.trim();
            const count = parseInt(document.getElementById('admin-count').value);
            if(!cat || !title || !baseUrl || !count) return alert("è³‡æ–™ä¸å…¨");

            const imageUrls = Array.from({length: count}, (_, i) => `${baseUrl}${(i+1).toString().padStart(2, '0')}.jpg`);
            await set(push(ref(db, `resources/library/${cat}`)), { title, images: imageUrls, createdAt: Date.now() });
            alert("åŒæ­¥æˆåŠŸï¼");
            triggerAdmin();
        };

        onValue(ref(db, 'resources/library'), (snap) => {
            library = snap.val() || {};
            const container = document.getElementById('library-content');
            container.innerHTML = "";
            Object.keys(library).forEach(cat => {
                const group = document.createElement('div');
                group.innerHTML = `<h3 class='text-zinc-600 text-[10px] font-black uppercase mb-2 border-l-2 border-red-600 pl-2'>${cat}</h3>`;
                Object.keys(library[cat]).forEach(id => {
                    const item = document.createElement('div');
                    item.className = "text-white font-bold py-2 px-4 bg-zinc-900 rounded cursor-pointer mb-2 text-sm";
                    item.innerText = library[cat][id].title;
                    item.onclick = () => { loadManga(library[cat][id].images, cat, library[cat][id].title); toggleDrawer(); };
                    group.appendChild(item);
                });
                container.appendChild(group);
            });
            document.getElementById('current-path').innerText = "GITHUB CLOUD SYNCED";
        });

        async function loadManga(urls, cat, title) {
            document.getElementById('current-path').innerText = `${cat} / ${title}`;
            const promises = urls.map(url => new Promise(res => { 
                const img = new Image(); 
                img.crossOrigin = "anonymous"; // âœ… ä¿®æ­£ï¼šè§£æ±º GitHub åœ–ç‰‡è·¨åŸŸå•é¡Œ
                img.onload = () => res(img); 
                img.onerror = () => res(null);
                img.src = url; 
            }));
            const results = await Promise.all(promises);
            mangaPages = results.filter(i => i !== null);
            currentIndex = 0; 
            render(); 
            updateDots();
        }

        function render() {
            if (!mangaPages.length) return;
            const img = mangaPages[currentIndex];
            const viewport = document.getElementById('manga-viewport');
            const vW = viewport.clientWidth, vH = viewport.clientHeight;
            const imgRatio = img.width / img.height, viewRatio = vW / vH;

            // âœ… ä¿®æ­£ï¼šè‡ªå‹•ç¸®æ”¾ Canvas æ¯”ä¾‹ï¼Œé˜²æ­¢è·‘ç‰ˆ
            if (imgRatio > viewRatio) {
                canvas.width = vW; canvas.height = vW / imgRatio;
            } else {
                canvas.height = vH; canvas.width = vH * imgRatio;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }

        function updateDots() {
            const nav = document.getElementById('dot-nav'); nav.innerHTML = "";
            mangaPages.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `w-1.5 h-1.5 rounded-full border border-white ${i === currentIndex ? 'bg-white' : 'opacity-30'}`;
                nav.appendChild(dot);
            });
        }

        window.nextPage = () => { if (currentIndex < mangaPages.length - 1) { currentIndex++; render(); updateDots(); } };
        window.prevPage = () => { if (currentIndex > 0) { currentIndex--; render(); updateDots(); } };
        window.startApp = () => { document.getElementById('landing-page').style.transform = 'translateY(-110%)'; document.getElementById('main-app').style.visibility = 'visible'; document.getElementById('main-app').style.opacity = '1'; };
        window.toggleDrawer = () => { document.getElementById('side-drawer').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('open'); };
        window.triggerAdmin = () => document.getElementById('admin-modal').classList.toggle('hidden');
        
        window.onload = () => {
            const savedBg = localStorage.getItem('user_hero_bg') || '';
            if (savedBg) parts.forEach(id => document.getElementById(id).style.backgroundImage = `url('${savedBg}')`);
            setTimeout(() => { document.getElementById('landing-page').classList.add('loaded'); document.getElementById('enter-btn-area').style.opacity = '1'; }, 100);
            lucide.createIcons();
        };
    </script>
</body>
</html>
